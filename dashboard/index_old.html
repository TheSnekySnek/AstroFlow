<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>AstroFlow</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/caman.full.min.js"></script>
    <script type="text/javascript" src="js/mjpeg.js"></script>
    
</head>
<body>
    <div class="container">
        <div class="scopeSys">
          <h2>Scope</h2>
          <div class="row">
            <div class="connectBtns col-sm">
                <button type="button" class="btn btn-primary" id="cnScope" onClick="cnScope()">Connect Scope</button>
            </div>
            <div class="controlBtns col-sm">
                <div class="btn-group-vertical btn-group-lg updown" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-secondary scopeBtn" onmousedown="slew('up', 0)" onmouseup="slew('up', 1)" disabled>Up</button>
                    <button type="button" class="btn btn-secondary scopeBtn" onmousedown="slew('down', 0)" onmouseup="slew('down', 1)" disabled>Down</button>
                </div>
                <div class="btn-group btn-group-lg leftright" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-secondary scopeBtn" onmousedown="slew('left', 0)" onmouseup="slew('right', 1)" disabled>Left</button>
                    <button type="button" class="btn btn-secondary scopeBtn" onmousedown="slew('right', 0)" onmouseup="slew('right', 1)" disabled>Right</button>
                </div>
                <div class="form-group ratecontrol">
                    <label for="slewrate" style="float:left;">Rate</label>
                    <select class="form-control" id="slewrate" style="float:right;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option selected value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>
            </div>
          </div>
          <div class="input-group mb-3  targetSelect">
              <div class="input-group-prepend">
                  <span class="input-group-text" id="inputGroup-sizing-sm">Target</span>
              </div>
              <input type="text" class="form-control" id="target" value="">
              <div class="input-group-append">
                  <button type="button" class="btn btn-outline-secondary scopeBtn" onClick="goTo()" disabled>GO</button>
              </div>
          </div>
        </div>
        <div class="cameraSys">
            <h2>Camera</h2>
            <div class="row">
              <div class="connectBtns col-sm">
                  <button type="button" class="btn btn-primary" id="cnCam" onClick="cnCam()">Connect Camera</button>
              </div>
            </div>

            <div class="row">
                <div class="col-sm">
                    <div class="input-group mb-3  targetSelect">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="inputGroup-sizing-sm">N</span>
                        </div>
                        <input type="text" class="form-control" id="num" value="">
                    </div>
                </div>
                <div class="col-sm">
                    <div class="input-group mb-3  targetSelect">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="inputGroup-sizing-sm">EXPO</span>
                        </div>
                        <input type="text" class="form-control" id="expo" value="">
                    </div>
                </div>
                
                <div class="col-sm">
                    <div class="input-group mb-3  targetSelect">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="inputGroup-sizing-sm">ISO</span>
                        </div>
                        <input type="text" class="form-control" id="iso" value="">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <button type="button" class="btn btn-success camBtn" onClick="snap()" id="imager" disabled>Start</button>
                </div>
                <div class="col-sm">
                    <button type="button" class="btn btn-info camBtn" id="previewer" onClick="prev()">Preview Single</button>
                </div>
                <div class="col-sm">
                    <button type="button" class="btn btn-info camBtn" id="previewerL" onClick="prevL()">Preview Long</button>
                </div>
                <!--<div class="col-sm">
                    <button type="button" class="btn btn-info camBtn" id="solver" onClick="solve()" disabled>Plate Solve</button>
                </div>-->
            </div>
            <div class="form-group">
                <label for="prevTime">Preview Expo</label>
                <select class="form-control" id="prevTime">
                    <option value="18">1/60</option>
                    <option value="21">1/30</option>
                    <option selected value="36">1</option>
                    <option value="46">10</option>
                    <option value="51">30</option>
                </select>
            </div>
            <div class="progress">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100"></div>  
            </div>
            <p id="progressInfo"></p>
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Preview</h5>
                <img id="prev" src="" alt="" style="width: 100%;height: auto;">
            </div>
            <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Plate Solve</h5>
                  <p id="psText">No Data</p>
                </div>
                <img id="psImg1" style="width: 100%;height: auto;" src="" alt="">
                <div class="row">
                    <div class="col-sm">
                        <img id="psImg2" style="width: 100%;height: auto;" src="" alt="">
                    </div>
                    <div class="col-sm">
                        <img id="psImg3" style="width: 100%;height: auto;" src="" alt="">
                    </div>
                </div>
                
              </div>
            
          </div>
          <div class="shutdown">
            <div class="input-group mb-3  targetSelect">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="inputGroup-sizing-sm">Pass</span>
                </div>
                <input type="password" class="form-control" id="shutpass" value="">
                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-secondary" onClick="restart()">RESTART</button>
                    <button type="button" class="btn btn-outline-secondary" onClick="shut()">OFF</button>
                </div>
            </div>
          </div>
          
    </div>
    

</body>
<script src="/socket.io/socket.io.js"></script>
<script>
    /*var player = new MJPEG.Player("player", window.location.href + "/images/live.mjpg");
    player.start();*/
    var isPreview = false
    var timer = 0
  /*var caman
  Caman("#prCanvas", "images/live.jpg", function () {
    caman = Caman("#prCanvas")
  });
    
  function applymod() {
    caman.revert()
    caman.brightness($("#brightSlider").val())
    caman.exposure($("#contSlider").val())
    caman.render()
  }
  var timer = 0
  $( "#brightSlider" ).val(0)
  $( "#contSlider" ).val(0)
  //Image Manipulation

  $( "#brightSlider" ).change(function() {
    applymod()
  });

  $( "#contSlider" ).change(function() {
    applymod()
  });*/

  function str_pad_left(string,pad,length) {
      return (new Array(length+1).join(pad)+string).slice(-length);
  }

  var socket = io();
  socket.on('preview', async function(msg){
    d = new Date();
    $("#prev").attr("src", "/images/capt0000.jpg?"+d.getTime());
  });
  socket.on('previewL', async function(msg){
    $(".camBtn").prop("disabled",false);
    d = new Date();
    $("#prev").attr("src", "/images/live.jpg?"+d.getTime());
  });
  socket.on('solved', async function(msg){
    $(".camBtn").prop("disabled",false);
    $("#psImg1").attr("src", "http://nova.astrometry.net/annotated_display/" + msg.jobId + ".jpg")
    $("#psImg2").attr("src", "http://nova.astrometry.net/sky_plot/zoom1/" + msg.calId)
    $("#psImg3").attr("src", "http://nova.astrometry.net/sky_plot/zoom2/" + msg.calId)
    $("#psText").text("RA: " + msg.data.ra + "\nDEC: " + msg.data.dec)
  });
  socket.on('cm', async function(msg){
    $("#cnCam").prop("disabled",true);
    $(".camBtn").prop("disabled",false);
    $("#cnCam").text("Camera Connected")
    
  });
  socket.on('pic', async function(msg){
    $('#progressBar').width(parseInt((msg.n / msg.max) *100) + "%")
    $('#progressBar').text(parseInt((msg.n / msg.max) *100) + "%")

    var ttime = msg.expo * msg.max
    timer += msg.expo
    diff = ttime - timer
    var minutes = Math.floor(parseInt((ttime - timer) / 1000) / 60);
    var seconds = parseInt((ttime - timer) / 1000) - minutes * 60;
    $('#progressInfo').text("Time Left: " + str_pad_left(minutes,'0',2)+':'+str_pad_left(seconds,'0',2))
    if(diff < 10){
        $(".camBtn").prop("disabled",false);
        $('#progressInfo').text("")
    }
  });
  socket.on('cs', async function(msg){
    $("#cnScope").prop("disabled",true);
    $(".scopeBtn").prop("disabled",false);
    $("#cnScope").text("Scope Connected")
  });
  function cnScope() {
    $("#cnScope").prop("disabled",true);
    socket.emit('cnScope', {});
  }
  function solve() {
    $(".camBtn").prop("disabled",true);
    socket.emit('solve', {});
  }
  function cnCam() {
    $("#cnCam").prop("disabled",true);
    socket.emit('cnCam', {});
  }
  function slew(direction, stp) {
    var rate = $( "#slewrate" ).find(":selected").val();
    console.log(rate)
    socket.emit('slew', {dir: direction, stp: stp, rate: rate});
  }
  function shut() {
    var pass = $('#shutpass').val()
    socket.emit('shut', {pwd: pass});
  }
  function restart() {
    socket.emit('restart', {});
  }
  function goTo() {
    socket.emit('goTo', {name: document.getElementById('target').value});
  }
  function prev() {
    var exp = $( "#prevTime" ).find(":selected").val();
    socket.emit('prev', {expo: exp});
  }
  function prevl() {
    socket.emit('prevl', {});
  }
  function snap() {
    socket.emit('snap', {num: document.getElementById('num').value, expo: document.getElementById('expo').value, iso: document.getElementById('iso').value});
    $(".camBtn").prop("disabled",true);
  }

  
</script>
</html>